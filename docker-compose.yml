
services:
  webapp:
    container_name: webapp
    build:
      context: ./backend
    ports:
      - "18080:18080"  
    volumes:
      - ./backend:/app  
      # - ./backend/static:/app/static
    env_file:
      - ./.env
    command: >
      bash -c "sleep 50 &&
      source /ctr-py-venv/bin/activate &&
      python manage.py makemigrations &&
      python manage.py migrate &&
      python manage.py collectstatic --noinput &&
      gunicorn screener_website.wsgi:application --bind 0.0.0.0:18080"
    depends_on:
      - database
    networks:
      - webapp_network

  database:
    image: postgres:17
    container_name: postgre
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    env_file:
      - ./.env
    ports:
      - 5432:5432
    networks:
      - webapp_network

  pgadmin:
    container_name: pgadmin
    image: dpage/pgadmin4
    env_file:
      - ./.env
    ports:
      - 5050:80
    networks:
      - webapp_network

  worker:
    build:
      context: ./backend
    hostname: worker
    volumes:
      - ./backend:/app
    env_file:
      - ./.env
    depends_on:
      - redis
      - webapp
      - database
    command: >
      bash -c "sleep 100 &&
      source /ctr-py-venv/bin/activate &&
      celery -A screener_website worker --loglevel=info"
    networks:
      - webapp_network

  redis:
    image: redis
    hostname: redis
    ports:
      - "6379:6379"
    networks:
      - webapp_network

  beat:
    build:
      context: ./backend
    hostname: beat
    volumes:
      - ./backend:/app
    env_file:
      - ./.env
    depends_on:
      - redis
      - webapp
      - worker
      - database
    command: >
      bash -c "sleep 150 &&
      source /ctr-py-venv/bin/activate &&
      celery -A screener_website beat --loglevel=info"
    networks:
      - webapp_network

  flower:
    build:
      context: ./backend
    hostname: flower
    ports:
      - "5555:5555"
    volumes:
      - ./backend:/app
    env_file:
      - ./.env      
    depends_on:
      - webapp
      - redis
      - worker
    command: >
      bash -c "sleep 150 &&
      source /ctr-py-venv/bin/activate &&
      celery -A screener_website flower --basic_auth=${FLOWER_USER}:${FLOWER_PASSWORD}"
    networks:
      - webapp_network

  telegram_bot:
    build: ./telegram_bot  
    container_name: telegram_bot
    volumes:
      - ./telegram_bot:/app
    env_file:
      - ./.env      
    command: python main.py
    networks:
      - webapp_network

  nginx:
    build: ./nginx
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./backend/staticfiles:/static:ro 
      - ./backend/images:/media:ro    
    depends_on:
      - webapp
    networks:
      - webapp_network

volumes:
  postgres_data:

networks:
  webapp_network:
